<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA Breakout Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script>
        const { useState, useEffect, createElement: e } = React;

        const EMADashboard = () => {
          const [data, setData] = useState([]);
          const [filteredData, setFilteredData] = useState([]);
          const [lastUpdate, setLastUpdate] = useState(null);
          const [source, setSource] = useState('');
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);
          const [sortConfig, setSortConfig] = useState({ key: 'ema50Distance', direction: 'ascending' });

          const [emaFilter, setEmaFilter] = useState('50');
          const [typeFilter, setTypeFilter] = useState('all');
          const [indexFilter, setIndexFilter] = useState('all');
          const [breakoutFilter, setBreakoutFilter] = useState('all');
          const [searchTerm, setSearchTerm] = useState('');

          useEffect(() => {
            loadData();
            const interval = setInterval(loadData, 5 * 60 * 1000);
            return () => clearInterval(interval);
          }, []);

          useEffect(() => {
            applyFilters();
          }, [data, emaFilter, typeFilter, indexFilter, breakoutFilter, searchTerm]);

          const loadData = async () => {
            try {
              setLoading(true);
              setError(null);

              const response = await fetch(`ema_scan_results.json?t=${Date.now()}`);

              if (response.ok) {
                const jsonData = await response.json();

                if (jsonData.data && Array.isArray(jsonData.data)) {
                  setData(jsonData.data);
                  setLastUpdate(new Date(jsonData.lastUpdate));
                  setSource(jsonData.source || 'External Data');
                  setLoading(false);
                  return;
                }
              }

              throw new Error('Could not load data');
            } catch (err) {
              setError('Failed to load scan results');
              setLoading(false);
            }
          };

          const applyFilters = () => {
            let filtered = [...data];

            if (typeFilter !== 'all') {
              filtered = filtered.filter(d => d.type === typeFilter);
            }

            if (indexFilter !== 'all') {
              filtered = filtered.filter(d => d.index === indexFilter);
            }

            const emaDistanceKey = emaFilter === '50' ? 'ema50Distance' : 'ema200Distance';

            if (breakoutFilter === 'near') {
              filtered = filtered.filter(d => d[emaDistanceKey] > -3 && d[emaDistanceKey] < 0);
            } else if (breakoutFilter === 'above') {
              filtered = filtered.filter(d => d[emaDistanceKey] > 0);
            } else if (breakoutFilter === 'below') {
              filtered = filtered.filter(d => d[emaDistanceKey] <= -3);
            }

            if (searchTerm) {
              const search = searchTerm.toLowerCase();
              filtered = filtered.filter(d =>
                d.name.toLowerCase().includes(search) ||
                d.symbol.toLowerCase().includes(search)
              );
            }

            setFilteredData(filtered);
          };

          const getBreakoutStatus = (distance) => {
            if (distance > 0) {
              return { status: 'Above', color: 'text-green-600', bg: 'bg-green-50', icon: '🟢' };
            } else if (distance > -3 && distance <= 0) {
              return { status: 'Near', color: 'text-yellow-600', bg: 'bg-yellow-50', icon: '🟡' };
            } else {
              return { status: 'Below', color: 'text-red-600', bg: 'bg-red-50', icon: '🔴' };
            }
          };

          const sortData = (key) => {
            let direction = 'ascending';
            if (sortConfig.key === key && sortConfig.direction === 'ascending') {
              direction = 'descending';
            }
            setSortConfig({ key, direction });
          };

          const getSortedData = () => {
            const sortableData = [...filteredData];
            sortableData.sort((a, b) => {
              if (a[sortConfig.key] < b[sortConfig.key]) {
                return sortConfig.direction === 'ascending' ? -1 : 1;
              }
              if (a[sortConfig.key] > b[sortConfig.key]) {
                return sortConfig.direction === 'ascending' ? 1 : -1;
              }
              return 0;
            });
            return sortableData;
          };

          const resetFilters = () => {
            setEmaFilter('50');
            setTypeFilter('all');
            setIndexFilter('all');
            setBreakoutFilter('all');
            setSearchTerm('');
          };

          const emaDistanceKey = emaFilter === '50' ? 'ema50Distance' : 'ema200Distance';
          const emaKey = emaFilter === '50' ? 'ema50' : 'ema200';

          const near50 = filteredData.filter(d => d[emaDistanceKey] > -3 && d[emaDistanceKey] < 0);
          const above50 = filteredData.filter(d => d[emaDistanceKey] > 0);
          const above200 = filteredData.filter(d => d.ema200Distance > 0);

          if (loading) {
            return e('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center' },
              e('div', { className: 'text-center' },
                e('div', { className: 'text-4xl mb-4' }, '📊'),
                e('div', { className: 'text-xl font-semibold text-slate-700' }, 'Loading scanner...')
              )
            );
          }

          if (error) {
            return e('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-6' },
              e('div', { className: 'bg-red-50 border-2 border-red-200 rounded-xl p-8 max-w-md' },
                e('div', { className: 'text-4xl mb-4 text-center' }, '❌'),
                e('h2', { className: 'text-xl font-semibold text-red-900 mb-2 text-center' }, 'Error'),
                e('p', { className: 'text-red-700 text-center' }, error),
                e('button', {
                  onClick: loadData,
                  className: 'mt-4 w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700'
                }, 'Retry')
              )
            );
          }

          return e('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6' },
            e('div', { className: 'max-w-7xl mx-auto' },
              // Header
              e('div', { className: 'bg-white rounded-xl shadow-lg p-6 mb-6' },
                e('div', { className: 'flex items-center justify-between mb-4' },
                  e('div', null,
                    e('h1', { className: 'text-3xl font-bold text-slate-800' }, '📈 EMA Breakout Scanner'),
                    e('p', { className: 'text-slate-600 mt-1' }, 'S&P 500 • NASDAQ-100 • Top 100 Crypto')
                  ),
                  e('button', {
                    onClick: loadData,
                    className: 'flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700'
                  }, '🔄 Refresh')
                ),
                lastUpdate && e('div', { className: 'text-sm text-slate-600' },
                  e('p', null, '📅 Last updated: ' + lastUpdate.toLocaleString()),
                  e('p', null, '🔗 Source: ' + source),
                  e('p', null, `📊 Total symbols: ${data.length} | Showing: ${filteredData.length}`)
                )
              ),

              // Filters
              e('div', { className: 'bg-white rounded-xl shadow-lg p-6 mb-6' },
                e('div', { className: 'flex items-center justify-between mb-4' },
                  e('h2', { className: 'text-lg font-semibold text-slate-800' }, '🔍 Filters'),
                  e('button', {
                    onClick: resetFilters,
                    className: 'text-sm text-blue-600 hover:text-blue-800 underline'
                  }, 'Reset All')
                ),
                e('div', { className: 'grid grid-cols-1 md:grid-cols-5 gap-4' },
                  e('div', null,
                    e('label', { className: 'block text-sm font-medium text-slate-700 mb-2' }, 'EMA'),
                    e('select', {
                      value: emaFilter,
                      onChange: (ev) => setEmaFilter(ev.target.value),
                      className: 'w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                    },
                      e('option', { value: '50' }, '50 EMA'),
                      e('option', { value: '200' }, '200 EMA')
                    )
                  ),
                  e('div', null,
                    e('label', { className: 'block text-sm font-medium text-slate-700 mb-2' }, 'Asset Type'),
                    e('select', {
                      value: typeFilter,
                      onChange: (ev) => setTypeFilter(ev.target.value),
                      className: 'w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                    },
                      e('option', { value: 'all' }, 'All Types'),
                      e('option', { value: 'stock' }, '📊 Stocks Only'),
                      e('option', { value: 'crypto' }, '🪙 Crypto Only')
                    )
                  ),
                  e('div', null,
                    e('label', { className: 'block text-sm font-medium text-slate-700 mb-2' }, 'Index'),
                    e('select', {
                      value: indexFilter,
                      onChange: (ev) => setIndexFilter(ev.target.value),
                      className: 'w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                    },
                      e('option', { value: 'all' }, 'All Indices'),
                      e('option', { value: 'SPY' }, 'S&P 500'),
                      e('option', { value: 'NASDAQ' }, 'NASDAQ-100'),
                      e('option', { value: 'CRYPTO' }, 'Crypto')
                    )
                  ),
                  e('div', null,
                    e('label', { className: 'block text-sm font-medium text-slate-700 mb-2' }, 'Status'),
                    e('select', {
                      value: breakoutFilter,
                      onChange: (ev) => setBreakoutFilter(ev.target.value),
                      className: 'w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                    },
                      e('option', { value: 'all' }, 'All Status'),
                      e('option', { value: 'near' }, '🟡 Near Breakout'),
                      e('option', { value: 'above' }, '🟢 Above EMA'),
                      e('option', { value: 'below' }, '🔴 Below EMA')
                    )
                  ),
                  e('div', null,
                    e('label', { className: 'block text-sm font-medium text-slate-700 mb-2' }, 'Search'),
                    e('input', {
                      type: 'text',
                      placeholder: 'Symbol or name...',
                      value: searchTerm,
                      onChange: (ev) => setSearchTerm(ev.target.value),
                      className: 'w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                    })
                  )
                )
              ),

              // Summary Cards
              e('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4 mb-6' },
                e('div', { className: 'bg-white rounded-lg shadow p-4' },
                  e('div', { className: 'text-2xl font-bold text-slate-800' }, filteredData.length),
                  e('div', { className: 'text-sm text-slate-600' }, 'Showing')
                ),
                e('div', { className: 'bg-yellow-50 rounded-lg shadow p-4 border-2 border-yellow-200' },
                  e('div', { className: 'text-2xl font-bold text-yellow-700' }, near50.length),
                  e('div', { className: 'text-sm text-yellow-700' }, `Near ${emaFilter} EMA`)
                ),
                e('div', { className: 'bg-green-50 rounded-lg shadow p-4 border-2 border-green-200' },
                  e('div', { className: 'text-2xl font-bold text-green-700' }, above50.length),
                  e('div', { className: 'text-sm text-green-700' }, `Above ${emaFilter} EMA`)
                ),
                e('div', { className: 'bg-blue-50 rounded-lg shadow p-4 border-2 border-blue-200' },
                  e('div', { className: 'text-2xl font-bold text-blue-700' }, above200.length),
                  e('div', { className: 'text-sm text-blue-700' }, 'Above 200 EMA')
                )
              ),

              // Data Table
              e('div', { className: 'bg-white rounded-xl shadow-lg overflow-hidden' },
                e('div', { className: 'overflow-x-auto' },
                  e('table', { className: 'w-full' },
                    e('thead', { className: 'bg-slate-100 border-b-2 border-slate-200' },
                      e('tr', null,
                        e('th', {
                          className: 'px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-200',
                          onClick: () => sortData('symbol')
                        }, 'Symbol ' + (sortConfig.key === 'symbol' ? (sortConfig.direction === 'ascending' ? '▲' : '▼') : '')),
                        e('th', { className: 'px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider' }, 'Name'),
                        e('th', { className: 'px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider' }, 'Type'),
                        e('th', {
                          className: 'px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-200',
                          onClick: () => sortData('currentPrice')
                        }, 'Price ' + (sortConfig.key === 'currentPrice' ? (sortConfig.direction === 'ascending' ? '▲' : '▼') : '')),
                        e('th', {
                          className: 'px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-200',
                          onClick: () => sortData(emaDistanceKey)
                        }, `${emaFilter} EMA Distance ` + (sortConfig.key === emaDistanceKey ? (sortConfig.direction === 'ascending' ? '▲' : '▼') : '')),
                        e('th', { className: 'px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider' }, `Status (${emaFilter} EMA)`)
                      )
                    ),
                    e('tbody', { className: 'divide-y divide-slate-200' },
                      getSortedData().map((item, index) => {
                        const currentEmaDistance = item[emaDistanceKey];
                        const currentEmaValue = item[emaKey];
                        const priceDistance = item.currentPrice - currentEmaValue;
                        const breakout = getBreakoutStatus(currentEmaDistance);

                        return e('tr', { key: index, className: 'hover:bg-slate-50' },
                          e('td', { className: 'px-4 py-3 font-semibold text-slate-900' }, item.symbol),
                          e('td', { className: 'px-4 py-3 text-slate-700' }, item.name),
                          e('td', { className: 'px-4 py-3' },
                            e('span', {
                              className: `px-2 py-1 rounded text-xs font-medium ${item.type === 'stock' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}`
                            }, item.type === 'stock' ? '📊 Stock' : '🪙 Crypto')
                          ),
                          e('td', { className: 'px-4 py-3 font-mono text-slate-900' }, '$' + item.currentPrice.toFixed(2)),
                          e('td', { className: 'px-4 py-3' },
                            e('div', { className: 'flex items-center gap-2' },
                              e('span', {
                                className: `font-semibold ${priceDistance > 0 ? 'text-green-600' : 'text-red-600'}`
                              },
                                e('span', { className: 'text-lg' }, priceDistance > 0 ? '↑' : '↓'),
                                ' $' + Math.abs(priceDistance).toFixed(2)
                              )
                            )
                          ),
                          e('td', { className: 'px-4 py-3' },
                            e('span', {
                              className: `px-3 py-1 rounded-full text-xs font-medium ${breakout.bg} ${breakout.color}`
                            }, breakout.icon + ' ' + breakout.status)
                          )
                        );
                      })
                    )
                  )
                ),
                filteredData.length === 0 && e('div', { className: 'text-center py-12' },
                  e('div', { className: 'text-4xl mb-4' }, '🔍'),
                  e('p', { className: 'text-slate-600' }, 'No results found. Try adjusting your filters.')
                )
              )
            )
          );
        };

        ReactDOM.render(React.createElement(EMADashboard), document.getElementById('root'));
    </script>
</body>
</html>